{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ object.name }} - ArtEkat</title>
    <link rel="shortcut icon" type="image/png" href="{% static "deps/media/logo.svg" %}"/>
</head>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="{% static "deps/css/artStyle.css" %}"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<body class="body">
  <div class="art">
    <div class="frame-2">
      <div class="frame-7">
        <img
          alt=""
          class="compass"
          src="https://static.overlay-tech.com/assets/757ed013-3834-4713-a8b2-8711d46b5610.svg"
        />
        <div class="frame-10"><button onclick="window.open(`{% url "main:index" %}`)" class="kontakty">Главная</button></div>
        <div class="frame-10"><button onclick="window.open(`{% url "map:map" %}`)" class="kontakty">Карта</button></div>
        <div class="frame-10"><button onclick="window.open(`{% url "main:about" %}`)" class="kontakty">О&nbsp;нас</button></div>
      </div>
      {% if not user.is_authenticated %}
            <button onclick="window.open(`{% url "user:login" %}`)" class="frame-11"><p class="vhod">Вход</p></button>
              {% else %}
              <p class="vhod frame-11">{{ user }}</p>
            {% endif %}
    </div>
    <div class="frame-86">
      <img
      id="place-image"
      alt=""
      class="frame-73"
      src={{ object.image.url }}
      />
      <div id="place-info" style=" box-shadow: 0 0 11px rgba(115, 55, 55, 0.89); margin-top: 30px; background-color: rgba(197, 104, 104, 0.5);border: 1px solid #ccc;border-radius: 8px; padding: 10px;margin-bottom: 10px;word-wrap: break-word;overflow-wrap: break-word; width: 680px;">
        <h1 id="place-name" style="  font-weight: 600; color: rgba(115, 55, 55, 1);margin-bottom: 20px;letter-spacing: 0.72px;">{{ object.name }}</h1>
        <div style="display: flex; flex-direction: row;">
          <p class="avtor-imja-familija">Автор:&nbsp;{{ object.author }}</p>
          <p id="autor-description" class="avtor-imja-familija"></p>
        </div>
        <div style="display: flex; flex-direction: row;">
          <p class="avtor-imja-familija">Адрес:&nbsp;{{ object.adress }}</p>
          <p id="street" class="avtor-imja-familija">
          </p>
        </div>
        <p class="avtor-imja-familija-emphasis-0" id="place-description">Описание места:&nbsp;</p>
          <p class="avtor-imja-familija-emphasis-0">{{ object.info }}</p>
        <div style="display: flex; flex-direction: row;">
          <p class="avtor-imja-familija">Рейтинг:&nbsp;</p>
            <div class="col text-center" style="margin-right: 245px">
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle active" ></button>
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle active" id="second"></button>
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle active" id="third"></button>
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle active" id="fourth"></button>
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle active" id="fifth"></button>
                <p class="avtor-imja-familija-1"> {{ object.rate }}</p>
            </div>
          <p id="autor-description" class="avtor-imja-familija"></p>
        </div>
      </div>
    </div>
    <!-- Форма для комментариев -->
    <div class="addCommenter">
        {% if user.is_authenticated %}
      <h2>Добавить отзыв</h2>
      <form class="form-1" action="" method="POST" id="{{object.id}}" >
            {% csrf_token %}
          {{comment_form}}
          <div class="col text-center">
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle" id="first"></button>
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle" id="second"></button>
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle" id="third"></button>
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle" id="fourth"></button>
                <button type="submit" class="fa fa-star fa-3x my-btn starStyle" id="fifth"></button>
            </div>
          <div>
              <button class="addCommentButton" >Оставить отзыв</button>
          </div>
      </form>
         {% else %}
            <p>Авторизуйтесь, чтобы получить возможность оставить свой отзыв об Арт-объекте! </p>
        {% endif %}
    </div>
    {% for comment in comments %}
      <blockquote class="comment-container">
        <p>{{ comment.author}}, {{ comment.caption}}, {{ comment.date_posted}}, {{ comment.rate }}</p>
        <footer class="blockquote-footer">
         <cite>{{comment.user}}
            {% if  object.author.id == user.id %}
            <a href="{% url "main:about" %}" style="color: #585858;"><i class="fa fa-trash fa-lg" aria-hidden="true"></i></a>
            {% endif %}
            {% if comment.user.id == user.id %}
                {% if comment.user.id == object.author.id %}
                {% else %}
                <a href="{% url "main:about" %}" style="color: #585858;"><i class="fa fa-trash fa-lg" aria-hidden="true"></i></a>
                {% endif %}
            {% endif %}
            </cite>
        </footer>
      </blockquote>
    {% endfor %}
    <!-- Секция для отображения комментариев -->
    <div id="commentsSection">
      <h2 style="color: rgba(41, 108, 99, 1); margin-right: 10px;">Отзывы</h2>
      <div id="commentsList">
        <!-- Здесь будут отображаться комментарии -->
      </div>
    </div>

    <div class="frame-3">
      <img
        alt=""
        class="compass-two"
        src="https://static.overlay-tech.com/assets/d326b5ec-204f-4bef-a085-eebf9e7dde34.svg"
      />
      <div>
        <div class="mainAndVk">
          <form action="https://mail.google.com/mail/u/0/#search/artekat196@gmail.com?compose=jrjtWvPDnJBBWmKptLwgxLlTqklCxfqQvxDgwfRBfQDlBkGLFkKWHgNqKHDMDFCRkPVjwXvb" target="_blank">
            <button class="mail"></button>
          </form>
          <form action="https://vk.com/id323571725" target="_blank">
            <button class="vk"></button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>

  // Функция для добавления комментариев
  function addComment(event) {
    event.preventDefault(); // Предотвращаем перезагрузку страницы при отправке формы

    var commentText = document.getElementById('comment').value;

    // Допустим, что пользователь уже зарегистрирован
    var username = 'John Doe';
    var avatarUrl = 'https://example.com/avatar.jpg';

    var newCommentContainer = document.createElement('div');
    newCommentContainer.className = 'frame-77 ';

    var avatar = document.createElement('img');
    avatar.src = avatarUrl;
    avatar.classNae = 'avatar';
    newCommentContainer.appendChild(avatar);

    var commentContent = document.createElement('div');
    commentContent.className = 'comment-text';
    commentContent.innerHTML = '<strong>' + ':</strong> ' + commentText;
    newCommentContainer.appendChild(commentContent);

    var commentsList = document.getElementById('commentsList');
    commentsList.appendChild(newCommentContainer);

    document.getElementById('comment').value = '';
  }



  const placeId = sessionStorage.getItem('selectedPlaceId'); // Получаем ID выбранного места

  // Можно использовать AJAX запрос для получения данных о месте по его ID
  // В данном примере используем статичные данные

</script>
<script>
const one = document.getElementById('first')
const two = document.getElementById('second')
const three = document.getElementById('third')
const four = document.getElementById('fourth')
const five = document.getElementById('fifth')

// get the form, confirm-box and csrf token
const form = document.querySelector('.rate-form')
const confirmBox = document.getElementById('confirm-box')
const csrf = document.getElementsByName('csrfmiddlewaretoken')

const handleStarSelect = (size) => {
    const children = form.children
    console.log(children[0])
    for (let i=0; i < children.length; i++) {
        if(i <= size) {
            children[i].classList.add('checked')
        } else {
            children[i].classList.remove('checked')
        }
    }
}

const handleSelect = (selection) => {
    switch(selection){
        case 'first': {
            // one.classList.add('checked')
            // two.classList.remove('checked')
            // three.classList.remove('checked')
            // four.classList.remove('checked')
            // five.classList.remove('checked')
            handleStarSelect(1)
            return
        }
        case 'second': {
            handleStarSelect(2)
            return
        }
        case 'third': {
            handleStarSelect(3)
            return
        }
        case 'fourth': {
            handleStarSelect(4)
            return
        }
        case 'fifth': {
            handleStarSelect(5)
            return
        }
        default: {
            handleStarSelect(0)
        }
    }

}

const getNumericValue = (stringValue) =>{
    let numericValue;
    if (stringValue === 'first') {
        numericValue = 1
    }
    else if (stringValue === 'second') {
        numericValue = 2
    }
    else if (stringValue === 'third') {
        numericValue = 3
    }
    else if (stringValue === 'fourth') {
        numericValue = 4
    }
    else if (stringValue === 'fifth') {
        numericValue = 5
    }
    else {
        numericValue = 0
    }
    return numericValue
}

if (one) {
    const arr = [one, two, three, four, five]

    arr.forEach(item=> item.addEventListener('mouseover', (event)=>{
        handleSelect(event.target.id)
    }))

    arr.forEach(item=> item.addEventListener('click', (event)=>{
        // value of the rating not numeric
        const val = event.target.id

        let isSubmit = false
        form.addEventListener('submit', e=>{
            e.preventDefault()
            if (isSubmit) {
                return
            }
            isSubmit = true
            // picture id
            const id = e.target.id
            // value of the rating translated into numeric
            const val_num = getNumericValue(val)

            $.ajax({
                type: 'POST',
                url: '/rate/',
                data: {
                    'csrfmiddlewaretoken': csrf[0].value,
                    'el_id': id,
                    'val': val_num,
                },
                success: function(response){
                    console.log(response)
                    confirmBox.innerHTML = `<h1>Successfully rated with ${response.score}</h1>`
                },
                error: function(error){
                    console.log(error)
                    confirmBox.innerHTML = '<h1>Ups... something went wrong</h1>'
                }
            })
        })
    }))
}
</script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="{% static 'deps/js/rating.js' %}"></script>
</body>
</html>